<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Share Config Tool for Audiobookshelf</title>
    <link rel="icon" href="/abs-icon-purple.svg" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }

        .hiw-bullets li {
            margin: 5px 20px;
            font-size: 14px;
            color: #555;
        }

        .waiting-indicator {
            margin-left: 35px;
            margin-top: 10px;
            padding: 10px 15px;
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            border-radius: 4px;
            font-size: 13px;
            color: #92400e;
            display: none;
        }

        .waiting-indicator.show {
            display: block;
        }

        .waiting-indicator .countdown {
            font-weight: 600;
        }

        .share-list {
            margin: 20px 0;
        }

        .share-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .share-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .share-item.enabled {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .share-item.optional {
            border-color: #fde68a;
            background: #fffbeb;
        }

        .share-item.not-mounted {
            border-color: #fca5a5;
            background: #fef2f2;
        }

        .share-item.not-mounted .share-help-text {
            background: #fee2e2;
            border-left-color: #ef4444;
            color: #991b1b;
        }

        .share-alert-icon {
            text-align: right;
            font-size: 26px;
            color: #b91c1c;
            margin-top: 6px;
            display: none;
        }

        .share-alert-icon.show {
            display: block;
        }

        .share-alert-inline {
            font-size: 18px;
            color: #b91c1c;
            margin-left: 8px;
        }

        .confirm-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.92);
            border: 2px solid #fca5a5;
            border-radius: 8px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 16px;
            text-align: center;
            z-index: 2;
        }

        .confirm-overlay.show {
            display: flex;
        }

        .confirm-text {
            color: #991b1b;
            font-weight: 600;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
        }

        .share-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .share-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .share-name {
            font-weight: 600;
            font-size: 16px;
            color: #1f2937;
            flex: 1;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.accessible {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.empty {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.permission-denied {
            background: #fed7aa;
            color: #9a3412;
        }

        .status-badge.not-mounted {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Legacy support */
        .status-badge.mounted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.unmounted {
            background: #fee2e2;
            color: #991b1b;
        }

        .share-details {
            margin-left: 35px;
            color: #6b7280;
            font-size: 14px;
        }

        .share-details p {
            margin: 5px 0;
        }

        .share-help-text {
            margin-left: 35px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f9fafb;
            border-left: 3px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            color: #6b7280;
        }

        .share-item.enabled .share-help-text {
            background: #ecfdf5;
            border-left-color: #10b981;
            color: #065f46;
        }

        .share-item.optional .share-help-text {
            background: #fff7ed;
            border-left-color: #f59e0b;
            color: #b45309;
        }

        .share-item.not-mounted.enabled .share-help-text {
            background: #fee2e2;
            border-left-color: #ef4444;
            color: #991b1b;
        }

        .share-actions {
            margin-left: 35px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-test {
            background: #f59e0b;
            color: white;
            font-size: 13px;
            padding: 6px 14px;
        }

        .btn-test:hover {
            background: #d97706;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .save-status {
            font-size: 13px;
            color: #6b7280;
        }

        .message-text {
            display: inline-block;
            height: 28px;
            margin: auto 0;
            display: flex;
            align-items: center;
        }

        .banner-spinner {
            width: 28px;
            height: 28px;
            border: 2px solid #bae6fd;
            border-top: 2px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .message.success strong {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .message.success code {
            background: #059669;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .message.info {
            background: #e0f2fe;
            color: #0b5394;
            border-left: 4px solid #0ea5e9;
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .message.with-icon {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .message.with-icon .message-icon {
            font-size: 28px;
            line-height: 1;
            display: flex;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 8px;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header-text h1 {
            margin: 0;
        }

        .header-text .subtitle {
            margin: 4px 0 0;
            font-size: 16px;
            color: #4b5563;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .app-status-pill {
            background: #f3f4f6;
            border-radius: 999px;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .app-status-pill.status-running {
            background: #dcfce7;
            color: #065f46;
        }

        .app-status-pill.status-starting {
            background: #fef3c7;
            color: #92400e;
        }

        .app-status-pill.status-stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-light.green {
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.8);
        }

        .status-light.red {
            background: #ef4444;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        .status-light.orange {
            background: #f59e0b;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }

        .status-light.gray {
            background: #d1d5db;
            box-shadow: 0 0 6px rgba(209, 213, 219, 0.6);
        }

        .status-label {
            font-weight: 500;
            font-size: 12px;
            text-transform: none;
            letter-spacing: 0.2px;
            color: #6b7280;
        }

        .header-actions .btn {
            font-size: 16px;
        }

        .status-indicator-label {
            font-size: 11px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .test-result.success {
            background: #d1fae5;
            color: #065f46;
        }

        .test-result.error {
            background: #fee2e2;
            color: #991b1b;
        }

        footer {
            margin: 30px -30px -30px -30px;
            padding: 20px 30px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }

        #startup-banner {
            position: relative;
            padding-right: 60px;
            min-height: 46px;
            display: flex;
            align-items: center;
        }

        .footer-left {
            display: flex;
            justify-content: flex-start;
        }

        .footer-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }

        .footer-version {
            font-size: 13px;
            color: #1f2937;
            font-weight: 500;
            line-height: 1.4;
        }

        .footer-version .version-badge {
            display: inline-block;
            background: transparent;
            padding: 0 4px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #6b7280;
            margin-left: 4px;
        }

        .footer-author {
            font-size: 12px;
            color: #6b7280;
        }

        .footer-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .btn-issue {
            background: #ffffff;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            font-size: 12px;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-block;
            white-space: nowrap;
        }

        .btn-issue:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .sponsor-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sponsor-container iframe {
            opacity: 0.85;
            transition: opacity 0.2s;
        }

        .sponsor-container iframe:hover {
            opacity: 1;
        }

        .sponsor-text {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            line-height: 1.3;
            width: auto;
        }

        .sponsor-button {
            width: auto;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .share-header {
                flex-wrap: wrap;
            }

            .app-header {
                flex-direction: column;
            }

            .header-actions {
                width: 100%;
                align-items: stretch;
            }

            .header-actions .btn {
                width: 100%;
            }

            .app-status-pill {
                width: 100%;
                justify-content: center;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            footer {
                grid-template-columns: 1fr;
                gap: 2px 2px;
                text-align: center;
            }

            .footer-left,
            .footer-center,
            .footer-right {
                justify-content: center;
                align-items: center;
            }

            .footer-right {
                align-items: center;
            }

            .sponsor-container {
                align-items: center;
            }

            .sponsor-text {
                text-align: center;
            }

            .btn-issue {
                width: auto;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="app-header">
                <div class="header-info">
                    <img src="abs-icon-purple.svg" alt="Audiobookshelf" style="width: 48px; height: 48px;">
                    <div class="header-text">
                        <h1>ABS Network Share Config Tool</h1>
                        <p class="subtitle">Manage the network shares used by Audiobookshelf.</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div id="app-status-pill" class="app-status-pill status-loading"
                        title="Checking Audiobookshelf status...">
                        <span class="status-label">Audiobookshelf Status:</span>
                        <span id="app-status-light" class="status-light gray"></span>
                    </div>
                    <button id="open-abs-btn" onclick="openAudiobookshelf()" class="btn btn-primary" disabled>
                        Open Audiobookshelf ‚Üí
                    </button>
                </div>
            </div>

            <div class="info-box">
                <p><strong>‚ÑπÔ∏è &nbsp; How it works:</strong></p>

                <ul class="hiw-bullets">

                    <li>Add your network shares containing media in the <a
                            href="javascript:window.open(window.location.protocol+'//'+window.location.hostname.split(':')[0]+'/files/Home', '_blank')"
                            style="color: #3b82f6; text-decoration: underline;">Umbrel Files app</a></li>
                    <li>All shares below are accessible in Audiobookshelf at
                        <code>/media/network/&lt;host&gt;/&lt;share&gt;</code>
                    </li>
                    <li><strong>Check the box</strong> for shares that are <strong>required</strong> ‚Äî Audiobookshelf
                        will wait for them to become available before starting</li>
                    <li><strong>Leave unchecked</strong> network shares that Audiobookshelf does not use ‚Äî the app will
                        start without waiting for them
                    </li>
                    <li><strong> Important:</strong> Audiobookshelf will only start if all the required network shares
                        are available.
                    </li>
                    <li><strong> Bookmark this page!</strong> If a required network share is unavailable, Audiobookshelf
                        will be prevented from starting up. In this situation, the App icon on the
                        Umbrel dashboard may remain stuck showing "Starting..." or "Updating...". Return to this page
                        for help solving the issue.
                    </li>
                </ul>
            </div>

            <div id="restart-required-message" class="message warning with-icon" style="display:none;"></div>
            <div id="not-mounted-message" class="message error with-icon" style="display:none;"></div>
            <div id="message"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Discovering network shares...</p>
            </div>

            <div id="content" style="display:none;">
                <div id="startup-banner" class="message info with-icon" style="display:none;">
                    <span class="message-icon">‚è≥</span>
                    <span class="message-text">Audiobookshelf is starting up...</span>
                    <span class="banner-spinner" id="startup-spinner"></span>
                </div>
                <div id="shares-container"></div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="refreshShares()">üîÑ Refresh Shares</button>
                    <span id="save-status" class="save-status"></span>
                </div>
            </div>

            <footer>
                <div class="footer-left">
                    <a href="https://github.com/saltedlolly/umbrel-app-store/issues" target="_blank"
                        class="btn-issue">üêõ Report an Issue</a>
                </div>
                <div class="footer-center">
                    <div class="footer-version">
                        Audiobookshelf: NAS Edition<span class="version-badge" id="version-display">v0.0.0.0</span>
                    </div>
                    <div class="footer-author"><a href="https://github.com/advplyr/audiobookshelf"
                            target="_blank">Audiobookshelf</a> by advplyr &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; <a
                            href="https://github.com/saltedlolly/umbrel-app-store" target="_blank">NAS Edition</a> by
                        saltedlolly</div>
                </div>
                <div class="footer-right">
                    <div class="sponsor-container">
                        <div class="sponsor-text">Please Support<br>App Development:</div>
                        <div class="sponsor-button">
                            <iframe src="https://github.com/sponsors/saltedlolly/button" title="Sponsor saltedlolly"
                                height="32" width="114" style="border: 0; border-radius: 6px;">
                            </iframe>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        let shares = [];
        let config = { enabledShares: [], shareSettings: {} };
        let appStatus = null;
        let statusPollingInterval = null;

        function openAudiobookshelf() {
            window.open('http://' + window.location.hostname + ':13378', '_blank');
        }

        // Show message
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = text;  // Use innerHTML to support HTML formatting
            messageDiv.style.display = 'block';

            // Auto-hide all messages after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Show/hide restart and not-mounted alerts
        function updateShareStatusMessages() {
            const restartDiv = document.getElementById('restart-required-message');
            const notMountedDiv = document.getElementById('not-mounted-message');
            const requiredShares = shares.filter(share => config.enabledShares.includes(share.fullPath));
            const requiresRestart = requiredShares.some(share => share.status === 'empty');
            const missingShares = requiredShares.some(share => share.status === 'not-mounted');

            if (requiresRestart) {
                restartDiv.innerHTML = '<div class="message-icon">üîÑ</div><div><strong>App Restart Required</strong><br>A network share was recently been added. You need to restart Audiobookshelf before it can acess it.<br>To restart, right-click the app icon on the Umbrel dashboard and select "Restart". </div>';
                restartDiv.style.display = 'flex';
            } else {
                restartDiv.style.display = 'none';
            }

            if (missingShares) {
                notMountedDiv.innerHTML = '<div class="message-icon">‚õîÔ∏è</div><div><strong>A Required Network Share is Not Mounted</strong><br>Please re-mount it in the Files app, or remove it as a required Network Share.</div>';
                notMountedDiv.style.display = 'flex';
            } else {
                notMountedDiv.style.display = 'none';
            }
        }

        // Load current configuration
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                config = await response.json();
            } catch (error) {
                console.error('Error loading configuration:', error);
            }
        }

        // Discover shares
        async function discoverShares() {
            try {
                const response = await fetch('/api/shares/discover');
                const data = await response.json();
                shares = data.shares || [];
                return shares;
            } catch (error) {
                console.error('Error discovering shares:', error);
                showMessage('Error discovering shares: ' + error.message, 'error');
                return [];
            }
        }

        // Test share access
        async function testShare(sharePath, shareIndex) {
            const resultDiv = document.getElementById(`test-result-${shareIndex}`);
            resultDiv.innerHTML = '<em>Testing...</em>';
            resultDiv.className = 'test-result';

            try {
                const response = await fetch('/api/shares/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sharePath })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úì ${result.message}`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `‚úó ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚úó Error: ${error.message}`;
            }
        }

        let saveDebounceTimer = null;
        let pendingConfirmShare = null; // fullPath of share awaiting confirmation
        let startupBannerTimer = null;
        let lastOverallStatus = null;
        let lastStatusReceived = null;

        function scheduleAutoSave() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) statusEl.textContent = 'Saving...';
            if (saveDebounceTimer) clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(() => saveConfiguration(true), 800);
        }

        function applyShareSelection(index, enabled) {
            const checkbox = document.getElementById(`share-${index}`);
            const share = shares[index];
            const shareDiv = checkbox.closest('.share-item');
            const helpText = shareDiv.querySelector('.share-help-text');
            if (pendingConfirmShare === share.fullPath) {
                pendingConfirmShare = null;
                hideConfirmOverlay(index);
            }

            checkbox.checked = enabled;

            if (enabled) {
                if (!config.enabledShares.includes(share.fullPath)) {
                    config.enabledShares.push(share.fullPath);
                }
                shareDiv.classList.add('enabled');
                shareDiv.classList.remove('optional');
                checkbox.title = 'Mark as optional (app will start without waiting)';
                helpText.innerHTML = '‚úì <strong>Required:</strong> Audiobookshelf will wait for this share to be available before starting';
            } else {
                config.enabledShares = config.enabledShares.filter(s => s !== share.fullPath);
                shareDiv.classList.remove('enabled');
                shareDiv.classList.add('optional');
                checkbox.title = 'Mark as required (app will wait for this share before starting)';
                helpText.innerHTML = '‚ìò <strong>Optional:</strong> Audiobookshelf will start without waiting for this share';
            }

            updateShareStatusMessages();
            scheduleAutoSave();
        }

        function showConfirmOverlay(index) {
            const overlay = document.getElementById(`confirm-overlay-${index}`);
            pendingConfirmShare = shares[index].fullPath;
            if (overlay) overlay.classList.add('show');
        }

        function hideConfirmOverlay(index) {
            const overlay = document.getElementById(`confirm-overlay-${index}`);
            if (overlay) overlay.classList.remove('show');
            if (shares[index] && pendingConfirmShare === shares[index].fullPath) {
                pendingConfirmShare = null;
            }
        }

        function positionStartupSpinner() {
            const banner = document.getElementById('startup-banner');
            const spinner = document.getElementById('startup-spinner');
            if (!banner || !spinner || spinner.style.display === 'none') return;

            const textEl = banner.querySelector('.message-text');
            const iconEl = banner.querySelector('.message-icon');
            const bannerWidth = banner.clientWidth || 0;
            const spinnerWidth = spinner.offsetWidth || 28;
            const gap = 16;
            const textWidth = (iconEl ? iconEl.offsetWidth : 0) + (textEl ? textEl.offsetWidth : 0);

            // Start centered
            let left = bannerWidth / 2;

            // Push right if text overlaps
            const minLeft = textWidth + gap + spinnerWidth / 2;
            if (left < minLeft) {
                left = minLeft;
            }

            // Clamp to right edge
            const maxLeft = bannerWidth - gap - spinnerWidth / 2;
            if (left > maxLeft) {
                left = maxLeft;
            }

            spinner.style.left = `${left}px`;
        }

        // Toggle share enabled state
        function toggleShare(index) {
            // If another confirm is pending, cancel it as "No" (keep required)
            if (pendingConfirmShare && pendingConfirmShare !== shares[index].fullPath) {
                const prevIdx = shares.findIndex(s => s.fullPath === pendingConfirmShare);
                if (prevIdx !== -1) {
                    applyShareSelection(prevIdx, true);
                }
                pendingConfirmShare = null;
            }

            const checkbox = document.getElementById(`share-${index}`);
            const share = shares[index];

            if (checkbox.checked) {
                applyShareSelection(index, true);
            } else {
                if (share.status === 'not-mounted') {
                    // Re-check until user confirms
                    checkbox.checked = true;
                    showConfirmOverlay(index);
                    return;
                }
                applyShareSelection(index, false);
            }
        }

        // Save configuration
        async function saveConfiguration(isAuto = false) {
            const statusEl = document.getElementById('save-status');
            try {
                if (statusEl && isAuto) statusEl.textContent = 'Saving...';

                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (statusEl) statusEl.textContent = 'Saved';
                    if (!isAuto) {
                        const message = `<strong>‚úì Configuration saved!</strong>`;
                        showMessage(message, 'success');
                    }
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    if (statusEl) statusEl.textContent = 'Save failed';
                    showMessage('‚úó Error saving configuration: ' + errorMsg, 'error');
                }
            } catch (error) {
                if (statusEl) statusEl.textContent = 'Save failed';
                showMessage('‚úó Error saving configuration: ' + error.message, 'error');
            }
        }

        // Refresh shares
        async function refreshShares() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            await initialize();
        }

        // Render shares
        function renderShares() {
            const container = document.getElementById('shares-container');

            // Update share status alerts
            updateShareStatusMessages();

            if (shares.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <h3>No Network Shares Found</h3>
                        <p>Add network shares in Umbrel's Files app first, then refresh this page.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="share-list">' + shares.map((share, index) => {
                const isEnabled = config.enabledShares.includes(share.fullPath);

                // Map status to display text
                const statusTextMap = {
                    'accessible': 'Accessible',
                    'empty': 'Empty',
                    'permission-denied': 'Permission Denied',
                    'not-mounted': 'Not Mounted'
                };

                const statusClass = share.status || (share.isMounted && share.isAccessible ? 'accessible' : 'not-mounted');
                const statusText = statusTextMap[statusClass] || 'Unknown';

                const helpText = isEnabled
                    ? '‚úì <strong>Required:</strong> Audiobookshelf will wait for this share to be available before starting'
                    : '‚ìò <strong>Optional:</strong> Audiobookshelf will start without waiting for this share';

                // Check if app is waiting for this share
                const isBlocking = isEnabled && statusClass !== 'accessible';
                // Only show waiting indicator if ABS is NOT running and appStatus.overallStatus === 'waiting'
                const waitingIndicator = isBlocking && appStatus && !appStatus.app.running && appStatus.app.overallStatus === 'waiting'
                    ? `<div class="waiting-indicator show" id="waiting-${index}">‚è≥ <strong>App is waiting for this share...</strong> <span class="countdown"></span></div>`
                    : `<div class="waiting-indicator" id="waiting-${index}"></div>`;

                return `
                    <div class="share-item ${isEnabled ? 'enabled' : 'optional'} ${(isEnabled && (statusClass === 'not-mounted' || statusClass === 'empty' || statusClass === 'permission-denied')) ? 'not-mounted' : ''}" id="share-item-${index}">
                        <div class="confirm-overlay ${pendingConfirmShare === share.fullPath ? 'show' : ''}" id="confirm-overlay-${index}" data-share="${share.fullPath}">
                            <div class="confirm-text">Are you sure you don't require this network share?</div>
                            <div class="confirm-actions">
                                <button class="btn btn-secondary" onclick="hideConfirmOverlay(${index});">No</button>
                                <button class="btn btn-primary" onclick="applyShareSelection(${index}, false);">Yes</button>
                            </div>
                        </div>
                        <div class="share-header">
                            <input 
                                type="checkbox" 
                                class="share-checkbox" 
                                id="share-${index}"
                                ${isEnabled ? 'checked' : ''}
                                onchange="toggleShare(${index})"
                                title="${isEnabled ? 'Mark as optional (app will start without waiting)' : 'Mark as required (app will wait for this share before starting)'}"
                            >
                            <label for="share-${index}" class="share-name">
                                ${share.host} / ${share.shareName}
                            </label>
                        ${(isEnabled && (statusClass === 'empty' || statusClass === 'not-mounted' || statusClass === 'permission-denied')) ? '<span class="share-alert-inline">‚ö†Ô∏è</span>' : ''}
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                        <div class="share-help-text">
                            ${helpText}
                        </div>
                        ${waitingIndicator}
                        <div class="share-details">
                            <p><strong>Path in Audiobookshelf:</strong> <code>/media/network/${share.fullPath}</code></p>
                            <p><strong>System Path:</strong> <code>${share.systemPath}</code></p>
                        </div>
                        <!-- share-actions removed: Test Access button and result area no longer needed -->
                    </div>
                `;
            }).join('') + '</div>';
        }

        // Load version information
        async function loadVersion() {
            try {
                const response = await fetch('/version.json');
                if (response.ok) {
                    const versionData = await response.json();
                    document.getElementById('version-display').textContent = `v${versionData.version}`;
                }
            } catch (error) {
                console.warn('Could not load version information:', error);
            }
        }

        // Update app status indicator
        function updateAppStatusDisplay(status) {
            const pill = document.getElementById('app-status-pill');
            const light = document.getElementById('app-status-light');
            const button = document.getElementById('open-abs-btn');
            const banner = document.getElementById('startup-banner');
            const bannerText = banner ? banner.querySelector('.message-text') : null;
            const bannerIcon = banner ? banner.querySelector('.message-icon') : null;
            const bannerSpinner = document.getElementById('startup-spinner');

            if (!pill || !light || !button || !status || !status.app) {
                pill.classList.remove('status-running', 'status-stopped', 'status-starting');
                pill.classList.add('status-stopped');
                light.className = 'status-light gray';
                button.disabled = true;
                button.title = 'Waiting...';
                pill.title = 'Waiting for Audiobookshelf status...';
                if (banner) banner.style.display = 'none';
                if (bannerSpinner) bannerSpinner.style.display = 'none';
                return;
            }

            const overall = status.app.overallStatus;
            const isRunning = status.app.running && overall === 'running';
            const isStarting = !isRunning && overall === 'starting';

            pill.classList.remove('status-running', 'status-stopped', 'status-starting');
            pill.classList.add(isRunning ? 'status-running' : isStarting ? 'status-starting' : 'status-stopped');

            light.className = `status-light ${isRunning ? 'green' : isStarting ? 'orange' : 'red'}`;

            button.disabled = !isRunning;
            button.title = isRunning
                ? 'Open Audiobookshelf'
                : isStarting
                    ? 'Audiobookshelf is starting...'
                    : 'Audiobookshelf is not available yet. Please wait...';

            pill.title = isRunning
                ? 'Audiobookshelf is running and the web UI is available.'
                : isStarting
                    ? 'Audiobookshelf has started and is coming online now.'
                    : (status.app.message
                        ? `Audiobookshelf is offline: ${status.app.message}`
                        : 'Audiobookshelf is offline or not responding.');

            // Startup banner logic
            if (banner) {
                if (isStarting) {
                    banner.style.display = 'flex';
                    if (bannerText) bannerText.textContent = 'Audiobookshelf is starting up...';
                    if (bannerIcon) bannerIcon.textContent = '‚è≥';
                    if (bannerSpinner) {
                        bannerSpinner.style.display = 'inline-block';
                        // Defer positioning to allow layout to settle
                        requestAnimationFrame(() => positionStartupSpinner());
                    }
                    if (startupBannerTimer) {
                        clearTimeout(startupBannerTimer);
                        startupBannerTimer = null;
                    }
                } else if (isRunning && lastOverallStatus === 'starting') {
                    banner.style.display = 'flex';
                    if (bannerText) bannerText.textContent = 'Audiobookshelf is now available.';
                    if (bannerIcon) bannerIcon.textContent = '‚úÖ';
                    if (bannerSpinner) bannerSpinner.style.display = 'none';
                    if (startupBannerTimer) clearTimeout(startupBannerTimer);
                    startupBannerTimer = setTimeout(() => {
                        banner.style.display = 'none';
                    }, 3000);
                } else {
                    if (!isRunning) {
                        banner.style.display = 'none';
                        if (bannerSpinner) bannerSpinner.style.display = 'none';
                        if (startupBannerTimer) {
                            clearTimeout(startupBannerTimer);
                            startupBannerTimer = null;
                        }
                    } else {
                        // Already running on load; keep banner hidden
                        banner.style.display = 'none';
                        if (bannerSpinner) bannerSpinner.style.display = 'none';
                    }
                }
            }

            lastOverallStatus = overall;
            lastStatusReceived = status;
        }

        // Poll status endpoint
        async function pollStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) return;

                const status = await response.json();
                appStatus = status;

                // Update app status indicator
                updateAppStatusDisplay(status);

                // Update shares with latest status
                if (status.shares && status.shares.length > 0) {
                    shares = status.shares;
                    renderShares();
                }
            } catch (error) {
                console.warn('Error polling status:', error);
            }
        }

        // Start polling
        function startPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            statusPollingInterval = setInterval(pollStatus, 5000); // Poll every 5 seconds
        }

        // Reposition spinner on resize when visible
        window.addEventListener('resize', () => {
            positionStartupSpinner();
        });

        // Stop polling
        function stopPolling() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
            }
        }

        // Initialize
        async function initialize() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';

            await loadVersion();
            await loadConfiguration();
            await discoverShares();

            renderShares();

            // Get initial status
            await pollStatus();

            // Start polling for status updates
            startPolling();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initialize);

        // Stop polling when page unloads
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>

</html>
