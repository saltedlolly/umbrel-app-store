#!/usr/bin/env bash
#
# Pre-stop hook for Audiobookshelf
# Cleans up dynamically-created containers (abs-server and abs-network-shares-checker)
# before the app shuts down. This ensures they don't become orphaned on uninstall.
#
set -euo pipefail

echo "[$(date +'%Y-%m-%d %H:%M:%S')] Running pre-stop hook..."

# Container names to clean up
CHECKER_CONTAINER="saltedlolly-audiobookshelf_abs-network-shares-checker_1"
ABS_SERVER_CONTAINER="saltedlolly-audiobookshelf_abs-server_1"

# Find Audiobookshelf data directory
if [ -d "/data/app-data/saltedlolly-audiobookshelf" ]; then
    APP_DATA_DIR="/data/app-data/saltedlolly-audiobookshelf"
elif [ -d "/root/Appdata/app-data/saltedlolly-audiobookshelf" ]; then
    APP_DATA_DIR="/root/Appdata/app-data/saltedlolly-audiobookshelf"
else
    APP_DATA_DIR="/data/saltedlolly-audiobookshelf"
fi
CONFIG_FILE="${APP_DATA_DIR}/data/network-shares.json"

# Reset network shares to 'checking' status for clean restart
if [ -f "$CONFIG_FILE" ]; then
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] Resetting network shares to 'checking' status..."
    
    if command -v jq &> /dev/null; then
        enabledShares=$(jq -r '.enabledShares // []' "$CONFIG_FILE")
        shareSettings=$(jq -r '.shareSettings // {}' "$CONFIG_FILE")
        
        # Rebuild shares object with only required shares set to 'checking'
        newShares='{}'
        for share in $(echo "$enabledShares" | jq -r '.[]'); do
            newShares=$(echo "$newShares" | jq --arg share "$share" '.[$share] = {"status": "checking", "lastCheckedAt": null}')
        done
        
        # Reconstruct config
        newConfig=$(echo '{}' | jq --argjson enabled "$enabledShares" '.enabledShares = $enabled')
        newConfig=$(echo "$newConfig" | jq --argjson settings "$shareSettings" '.shareSettings = $settings')
        newConfig=$(echo "$newConfig" | jq --argjson shares "$newShares" '.shares = $shares')
        
        echo "$newConfig" > "$CONFIG_FILE"
        
        requiredCount=$(echo "$enabledShares" | jq 'length')
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✓ Reset $requiredCount required share(s) to 'checking' - awaiting next check"
    else
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] ⚠ jq not found - skipping share reset (will perform on next startup)"
    fi
else
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ℹ No network shares config found"
fi

# Function to gracefully stop a container
stop_container() {
  local container_name="$1"
  
  if docker ps -a --filter "name=^${container_name}$" --format "{{.Names}}" | grep -q "^${container_name}$"; then
    # Check if it's running
    if docker ps --filter "name=^${container_name}$" --format "{{.Names}}" | grep -q "^${container_name}$"; then
      echo "[$(date +'%Y-%m-%d %H:%M:%S')] Stopping container: $container_name"
      docker stop -t 30 "$container_name" 2>/dev/null || true
      echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✓ Stopped: $container_name"
    else
      echo "[$(date +'%Y-%m-%d %H:%M:%S')] Container already stopped: $container_name"
    fi
  else
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] Container not found: $container_name"
  fi
}

# Stop the containers gracefully
stop_container "$CHECKER_CONTAINER"
stop_container "$ABS_SERVER_CONTAINER"

echo "[$(date +'%Y-%m-%d %H:%M:%S')] ✓ Pre-stop hook complete"

exit 0
