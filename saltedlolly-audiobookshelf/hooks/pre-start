#!/usr/bin/env bash
#
# Pre-start hook for Audiobookshelf
# Waits for selected network shares to be mounted before allowing the app to start
# This prevents the "share isn't mounted yet" problem after reboots
#
# Configuration is read from ${APP_DATA_DIR}/network-shares.json
# This file is managed by the network-shares-ui sidecar service
#
set -euo pipefail

# Configuration
readonly CONFIG_FILE="${APP_DATA_DIR}/network-shares.json"
readonly MAX_WAIT_SECONDS=300  # 5 minutes total timeout
readonly CHECK_INTERVAL=2      # Check every 2 seconds
readonly NETWORK_MOUNT_ROOT="${UMBREL_ROOT}/network"
readonly AUDIOBOOKSHELF_HOME="${UMBREL_ROOT}/home/Audiobookshelf"
readonly AUDIOBOOKS_DIR="${AUDIOBOOKSHELF_HOME}/Audiobooks"
readonly PODCASTS_DIR="${AUDIOBOOKSHELF_HOME}/Podcasts"

# Logging helpers
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] $*"
}

log_info() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] INFO: $*"
}

log_error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] ERROR: $*" >&2
}

log_warn() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] WARN: $*" >&2
}

# Fix permissions on APP_DATA_DIR (Umbrel creates these but not with correct ownership)
log "Checking permissions on app data directories..."

if [[ -d "${APP_DATA_DIR}/data" ]]; then
    # Check ownership on the data directory and subdirectories
    log_info "Fixing ownership on ${APP_DATA_DIR}/data and subdirectories..."
    
    if ! chown -R 1000:1000 "${APP_DATA_DIR}/data"; then
        log_error "Failed to fix ownership on ${APP_DATA_DIR}/data"
        log_error "Please run manually: sudo chown -R 1000:1000 ${APP_DATA_DIR}/data"
        exit 1
    fi
    
    log "âœ“ App data directory ownership fixed"
else
    log_warn "Data directory not found at ${APP_DATA_DIR}/data"
fi

# Ensure network-shares.json is writable (network-shares-ui runs as node user - UID 1000)
# Create it with correct permissions if it doesn't exist
if [[ ! -f "${CONFIG_FILE}" ]]; then
    log "Creating network-shares.json with default configuration..."
    echo '{"enabledShares":[],"shareSettings":{}}' > "${CONFIG_FILE}"
fi

log "Fixing permissions on network-shares.json..."
chown 1000:1000 "${CONFIG_FILE}"
chmod 644 "${CONFIG_FILE}"
log "âœ“ Network shares configuration file is ready"

# Ensure share-waiter script is available inside APP_DATA_DIR for container bind mount
SHARE_WAITER_SRC="$(cd "$(dirname "$0")/.." && pwd)/scripts/wait-for-shares.js"
SHARE_WAITER_DST="${APP_DATA_DIR}/scripts/wait-for-shares.js"
log "Ensuring share-waiter script is available at ${SHARE_WAITER_DST}"
mkdir -p "$(dirname "${SHARE_WAITER_DST}")"
if [[ -f "${SHARE_WAITER_SRC}" ]]; then
    if cp -f "${SHARE_WAITER_SRC}" "${SHARE_WAITER_DST}"; then
        log "âœ“ Copied share-waiter script from bundle"
    else
        log_error "Failed to copy share-waiter script from bundle"
    fi
else
    log_warn "Share-waiter script not found at ${SHARE_WAITER_SRC}, writing fallback copy"
    cat > "${SHARE_WAITER_DST}" <<'EOF'
#!/usr/bin/env node

/**
 * Waits for required network shares to become available before allowing
 * Audiobookshelf to launch. Intended to run inside the share-waiter sidecar.
 */

const fs = require('fs');
const fsp = fs.promises;
const path = require('path');

const CONFIG_FILE = process.env.CONFIG_FILE || '/data/network-shares.json';
const NETWORK_ROOT = process.env.NETWORK_MOUNT_ROOT || '/media/network';
const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 5000);

const log = (...args) => {
    const timestamp = new Date().toISOString();
    console.log(`[SHARE-WAITER] [${timestamp}]`, ...args);
};

async function readConfig() {
    try {
        const raw = await fsp.readFile(CONFIG_FILE, 'utf8');
        return JSON.parse(raw);
    } catch (error) {
        log('Failed to read config file, assuming no required shares:', error.message);
        return { enabledShares: [] };
    }
}

async function isMountAccessible(mountPath) {
    try {
        const stat = await fsp.stat(mountPath);
        if (!stat.isDirectory()) return false;
        await fsp.access(mountPath, fs.constants.R_OK);
        const entries = await fsp.readdir(mountPath);
        if (entries.length === 0) {
            log(`WARN: ${mountPath} is accessible but empty (could be a failed mount).`);
        }
        return true;
    } catch {
        return false;
    }
}

async function evaluateShares() {
    const config = await readConfig();
    const shares = config.enabledShares || [];
    if (shares.length === 0) {
        return { total: 0, outstanding: [] };
    }

    const outstanding = [];
    for (const share of shares) {
        if (!share) continue;
        const mountPath = path.join(NETWORK_ROOT, share);
        if (!(await isMountAccessible(mountPath))) {
            outstanding.push({ name: share, path: mountPath });
        }
    }
    return { total: shares.length, outstanding };
}

async function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function main() {
    log('Starting share-waiter service (continuous mode) [fallback copy]');

    while (true) {
        const { total, outstanding } = await evaluateShares();

        if (total === 0) {
            log('No required network shares configured. Skipping wait.');
            break;
        }

        if (outstanding.length === 0) {
            log('All required network shares are ready.');
            break;
        }

        const list = outstanding.map(s => `${s.name} (${s.path})`).join(', ');
        log(`Waiting for ${outstanding.length}/${total} required share(s): ${list}`);
        await sleep(CHECK_INTERVAL_MS);
    }
}

main()
    .then(() => process.exit(0))
    .catch(error => {
        log('ERROR:', error.message || error);
        process.exit(1);
    });
EOF
fi

# Fix permissions and show the directory contents for debugging
if chown 1000:1000 "${SHARE_WAITER_DST}" && chmod 644 "${SHARE_WAITER_DST}"; then
    log "âœ“ Share-waiter script ready with correct permissions"
else
    log_error "Failed to set permissions on share-waiter script"
fi
ls -l "$(dirname "${SHARE_WAITER_DST}")" || true

# Ensure media directories exist in /home (config/metadata in APP_DATA_DIR is auto-created by Umbrel)
log "Ensuring media directories exist in /home/Audiobookshelf..."

# Create Audiobooks directory
if [[ ! -d "${AUDIOBOOKS_DIR}" ]]; then
    log "Creating Audiobooks directory: ${AUDIOBOOKS_DIR}"
    if mkdir -p "${AUDIOBOOKS_DIR}"; then
        log "âœ“ Audiobooks directory created successfully"
    else
        log_error "Failed to create Audiobooks directory"
        exit 1
    fi
else
    log "âœ“ Audiobooks directory already exists"
fi

# Create README in Audiobooks directory
cat > "${AUDIOBOOKS_DIR}/README.txt" << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        AUDIOBOOKS FOLDER - ORGANIZATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This folder is for storing your audiobook files. Audiobookshelf will scan this
directory to build your audiobook library.

ðŸ“ RECOMMENDED FOLDER STRUCTURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Audiobooks/
â”œâ”€â”€ Author Name/
â”‚   â”œâ”€â”€ Series Name/
â”‚   â”‚   â”œâ”€â”€ Book 1 - Title/
â”‚   â”‚   â”‚   â”œâ”€â”€ Audio Track 1.mp3
â”‚   â”‚   â”‚   â”œâ”€â”€ Audio Track 2.mp3
â”‚   â”‚   â”‚   â””â”€â”€ cover.jpg
â”‚   â”‚   â””â”€â”€ Book 2 - Title/
â”‚   â”‚       â””â”€â”€ Audiobook.m4b
â”‚   â””â”€â”€ Standalone Book/
â”‚       â””â”€â”€ Audio File.m4a
â””â”€â”€ Another Author/
    â””â”€â”€ Book Title/
        â”œâ”€â”€ Disc 1/
        â”‚   â”œâ”€â”€ Track 1.mp3
        â”‚   â””â”€â”€ Track 2.mp3
        â””â”€â”€ Disc 2/
            â”œâ”€â”€ Track 1.mp3
            â””â”€â”€ Track 2.mp3

ðŸ“ FOLDER NAMING CONVENTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

You can include additional metadata in folder names:

â€¢ Title only:              "Wizards First Rule"
â€¢ With narrator:           "Wizards First Rule {Sam Tsoutsouvas}"
â€¢ With publish year:       "1994 - Wizards First Rule"
â€¢ With series sequence:    "Book 1 - Wizards First Rule"
â€¢ With subtitle:           "Wizards First Rule - A Really Good Subtitle"
â€¢ Full format:             "Vol 1 - 1994 - Wizards First Rule {Narrator}"

Author names support:
â€¢ First Last:              "Terry Goodkind"
â€¢ Last, First:             "Goodkind, Terry"
â€¢ Multiple authors:        "Author One & Author Two"
                          "Last1, First1, Last2, First2"

ðŸŽµ SUPPORTED AUDIO FORMATS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.mp3, .m4b, .m4a, .flac, .opus, .ogg, .oga, .mp4, .aac, .wma, .aiff, .wav, .webm

ðŸ’¡ TIPS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ All audio files in a folder will be grouped into one audiobook
â€¢ Subfolders for the audiobook are supported but the folders must be named 
  "Disc 1", "CD 2", "Disk 3", "Disc004", or "Disc1" (case insensitive)
â€¢ Place a cover.jpg/png in the folder for custom cover art
â€¢ Audiobookshelf can read metadata from audio file ID3 tags
â€¢ To add the same audiobook to multiple book series, use mp3tag to edit the CONTENTGROUP tag. 
  (e.g. For the book "The Alloy of Law" by Brandon Sanderson, you could enter:
  "Mistborn Saga #5; Mistborn: Wax & Wayne #1; The Cosmere" to add it to these three series)
â€¢ Create a desc.txt file for custom descriptions
â€¢ Create a reader.txt file to specify narrator

ðŸ“š LEARN MORE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For complete documentation on organizing audiobooks:
https://www.audiobookshelf.org/docs/#book-directory-structure

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# Create Podcasts directory
if [[ ! -d "${PODCASTS_DIR}" ]]; then
    log "Creating Podcasts directory: ${PODCASTS_DIR}"
    if mkdir -p "${PODCASTS_DIR}"; then
        log "âœ“ Podcasts directory created successfully"
    else
        log_error "Failed to create Podcasts directory"
        exit 1
    fi
else
    log "âœ“ Podcasts directory already exists"
fi

# Create README in Podcasts directory
cat > "${PODCASTS_DIR}/README.txt" << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         PODCASTS FOLDER - ORGANIZATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This folder is for storing podcast episodes you've downloaded manually.
Audiobookshelf can also subscribe to and auto-download podcasts directly.

ðŸ“ RECOMMENDED FOLDER STRUCTURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Podcasts/
â”œâ”€â”€ Podcast Name 1/
â”‚   â”œâ”€â”€ Episode 1.mp3
â”‚   â”œâ”€â”€ Episode 2.mp3
â”‚   â”œâ”€â”€ Episode 3.mp3
â”‚   â””â”€â”€ cover.jpg
â””â”€â”€ Podcast Name 2/
    â”œâ”€â”€ #01 - Episode Title.mp3
    â”œâ”€â”€ #02 - Another Episode.mp3
    â””â”€â”€ cover.png

âš ï¸  IMPORTANT: FLAT STRUCTURE ONLY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Podcasts do NOT support nested folders (no season folders).
All episodes for a podcast must be in the same folder with the podcast name.

âœ… Correct:   Podcasts/My Podcast/episode1.mp3
âŒ Incorrect: Podcasts/My Podcast/Season 1/episode1.mp3

ðŸŽµ SUPPORTED AUDIO FORMATS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.mp3, .m4a, .flac, .opus, .ogg, .oga, .mp4, .aac, .wma, .aiff, .wav, .webm

ðŸ’¡ BETTER OPTION: SUBSCRIBE IN AUDIOBOOKSHELF
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Instead of manually downloading and organizing podcast files, you can:

1. Search for podcasts directly in Audiobookshelf
2. Subscribe to podcasts
3. Auto-download new episodes
4. Manage episodes from within the app

Manual file organization is only needed if you have existing podcast files
or want to archive episodes.

ðŸ“š LEARN MORE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For complete documentation on podcasts:
https://www.audiobookshelf.org/docs/#podcast-directory-structure

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# Set ownership to 1000:1000 so Audiobookshelf container can write to media directories
log "Setting ownership to 1000:1000 on media directories..."
if ! chown -R 1000:1000 "${AUDIOBOOKSHELF_HOME}"; then
    log_error "Failed to set ownership on ${AUDIOBOOKSHELF_HOME}"
    log_error "Please run manually: sudo chown -R 1000:1000 ~/umbrel/home/Audiobookshelf/"
    exit 1
fi

log "âœ“ Media directories ready at ${AUDIOBOOKSHELF_HOME}"
log "These directories are visible in Files app at /Home/Audiobookshelf and survive app uninstalls"

log "Network share readiness will now be handled by the share-waiter service."
log "Starting app immediately."
exit 0
