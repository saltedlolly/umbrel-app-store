#!/usr/bin/env bash
#
# Pre-start hook for Audiobookshelf
# Waits for selected network shares to be mounted before allowing the app to start
# This prevents the "share isn't mounted yet" problem after reboots
#
# Configuration is read from ${APP_DATA_DIR}/network-shares.json
# This file is managed by the network-shares-ui sidecar service
#
set -euo pipefail

# Configuration
readonly CONFIG_FILE="${APP_DATA_DIR}/network-shares.json"
readonly MAX_WAIT_SECONDS=300  # 5 minutes total timeout
readonly CHECK_INTERVAL=2      # Check every 2 seconds
readonly NETWORK_MOUNT_ROOT="${UMBREL_ROOT}/network"
readonly PERSISTENT_DATA_ROOT="${UMBREL_ROOT}/data/storage/Audiobookshelf/app-data"

# Logging helpers
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] $*"
}

log_error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] ERROR: $*" >&2
}

log_warn() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] WARN: $*" >&2
}

# Check if jq is available for JSON parsing
if ! command -v jq &> /dev/null; then
    log_error "jq is not installed. Cannot parse network shares configuration."
    log_error "Continuing anyway, but network share wait functionality is disabled."
    exit 0
fi

# Ensure data directories exist with correct ownership
log "Ensuring persistent data directories exist..."

# Create config directory
if [[ ! -d "${PERSISTENT_DATA_ROOT}/config" ]]; then
    log "Creating config directory: ${PERSISTENT_DATA_ROOT}/config"
    if mkdir -p "${PERSISTENT_DATA_ROOT}/config"; then
        log "✓ Config directory created successfully"
    else
        log_error "Failed to create config directory"
        exit 1
    fi
else
    log "✓ Config directory already exists"
fi

# Create metadata directory
if [[ ! -d "${PERSISTENT_DATA_ROOT}/metadata" ]]; then
    log "Creating metadata directory: ${PERSISTENT_DATA_ROOT}/metadata"
    if mkdir -p "${PERSISTENT_DATA_ROOT}/metadata"; then
        log "✓ Metadata directory created successfully"
    else
        log_error "Failed to create metadata directory"
        exit 1
    fi
else
    log "✓ Metadata directory already exists"
fi

# Create metadata/logs subdirectory
if [[ ! -d "${PERSISTENT_DATA_ROOT}/metadata/logs" ]]; then
    log "Creating metadata/logs directory: ${PERSISTENT_DATA_ROOT}/metadata/logs"
    if mkdir -p "${PERSISTENT_DATA_ROOT}/metadata/logs"; then
        log "✓ Metadata/logs directory created successfully"
    else
        log_error "Failed to create metadata/logs directory"
        exit 1
    fi
else
    log "✓ Metadata/logs directory already exists"
fi

# Set ownership to 1000:1000 (Audiobookshelf container user)
# ALWAYS set ownership, even if directories already exist (fixes permission inheritance issues)
log "Setting ownership to 1000:1000 on persistent data directories..."

# Set ownership on entire app-data tree
if ! chown -R 1000:1000 "${PERSISTENT_DATA_ROOT}"; then
    log_error "Failed to set ownership on ${PERSISTENT_DATA_ROOT}"
    log_error "Current ownership:"
    ls -la "${PERSISTENT_DATA_ROOT}"
    ls -la "${PERSISTENT_DATA_ROOT}/metadata" 2>/dev/null || true
    log_error "Please run manually: sudo chown -R 1000:1000 ~/umbrel/data/storage/Audiobookshelf/"
    exit 1
fi

# Verify ownership was actually set
log "Verifying ownership..."
ACTUAL_OWNER=$(stat -c '%u:%g' "${PERSISTENT_DATA_ROOT}/metadata/logs" 2>/dev/null || stat -f '%u:%g' "${PERSISTENT_DATA_ROOT}/metadata/logs" 2>/dev/null)
if [[ "$ACTUAL_OWNER" != "1000:1000" ]]; then
    log_error "Ownership verification failed!"
    log_error "Expected: 1000:1000, Got: $ACTUAL_OWNER"
    log_error "Filesystem might not support ownership or parent has restrictive permissions"
    log_error "Directory listing:"
    ls -lan "${PERSISTENT_DATA_ROOT}/metadata/"
    exit 1
fi

log "✓ Ownership set and verified: ${PERSISTENT_DATA_ROOT}"

log "Persistent data directories ready at ${PERSISTENT_DATA_ROOT}"
log "These directories will survive app uninstalls and can be accessed via Umbrel Files app"

# Check if config file exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    log "No network shares configuration found at $CONFIG_FILE"
    log "No network shares configured - starting app immediately."
    log "You can configure network shares at: http://umbrel.local:23378"
    exit 0
fi

# Parse enabled shares from config
log "Reading network shares configuration from $CONFIG_FILE"
ENABLED_SHARES=$(jq -r '.enabledShares[]?' "$CONFIG_FILE" 2>/dev/null || echo "")

if [[ -z "$ENABLED_SHARES" ]]; then
    log "No network shares are enabled in configuration"
    log "Starting app immediately (no shares to wait for)."
    log "Configure network shares at: http://umbrel.local:23378"
    exit 0
fi

log "Found enabled network shares in configuration:"
while IFS= read -r share; do
    log "  - $share"
done <<< "$ENABLED_SHARES"

# Function to check if a mount point is actually mounted and accessible
is_mount_accessible() {
    local mount_path="$1"
    
    # Check 1: Does the path exist?
    if [[ ! -d "$mount_path" ]]; then
        return 1
    fi
    
    # Check 2: Is it actually mounted? (using mountpoint command if available)
    if command -v mountpoint &> /dev/null; then
        if ! mountpoint -q "$mount_path" 2>/dev/null; then
            return 1
        fi
    fi
    
    # Check 3: Can we actually read from it?
    if ! ls "$mount_path" &> /dev/null; then
        return 1
    fi
    
    # Check 4: Is it not empty (genuine NAS mount issue detection)
    # Note: An empty directory might indicate the mount failed silently
    local file_count
    file_count=$(find "$mount_path" -maxdepth 1 -type f -o -type d | wc -l)
    if [[ $file_count -le 1 ]]; then
        log_warn "Mount path $mount_path exists but appears empty (might not be mounted)"
        # Don't fail on this - empty NAS folders are valid
    fi
    
    return 0
}

# Function to wait for a single share to be mounted
wait_for_share() {
    local share_name="$1"
    local start_time
    start_time=$(date +%s)
    
    # Construct the full mount path
    # Network shares are typically mounted at /Network/<host>/<share> in Umbrel's virtual filesystem
    # But the actual system path is ${UMBREL_ROOT}/data/storage/network/<host>/<share>
    local mount_path="${NETWORK_MOUNT_ROOT}/${share_name}"
    
    log "Waiting for network share to be mounted: $share_name"
    log "Expected mount path: $mount_path"
    
    while true; do
        local current_time
        current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        
        if [[ $elapsed -ge $MAX_WAIT_SECONDS ]]; then
            log_error "Timeout waiting for network share: $share_name"
            log_error "Mount path: $mount_path"
            log_error "The share did not become available within $MAX_WAIT_SECONDS seconds."
            log_error ""
            log_error "Possible reasons:"
            log_error "  1. The NAS/network storage is offline or unreachable"
            log_error "  2. Network connectivity issues"
            log_error "  3. Incorrect credentials (check Umbrel Files app)"
            log_error "  4. The share was removed from Umbrel's Files app"
            log_error ""
            log_error "Please check:"
            log_error "  - Is the NAS powered on and connected to the network?"
            log_error "  - Can you access the share in Umbrel's Files app?"
            log_error "  - Are the credentials still valid?"
            log_error ""
            log_error "You can:"
            log_error "  - Fix the NAS connection and restart this app"
            log_error "  - Disable this share in the Network Shares settings"
            return 1
        fi
        
        if is_mount_accessible "$mount_path"; then
            log "✓ Network share is mounted and accessible: $share_name"
            return 0
        fi
        
        # Show progress every 10 seconds
        if [[ $((elapsed % 10)) -eq 0 ]] && [[ $elapsed -gt 0 ]]; then
            log "Still waiting for $share_name... (${elapsed}s elapsed)"
        fi
        
        sleep "$CHECK_INTERVAL"
    done
}

# Main logic: Wait for all enabled shares
log "Starting network share availability check..."
log "Maximum wait time: ${MAX_WAIT_SECONDS}s per share"

FAILED_SHARES=()
SUCCEEDED_SHARES=()

while IFS= read -r share; do
    if [[ -z "$share" ]]; then
        continue
    fi
    
    if wait_for_share "$share"; then
        SUCCEEDED_SHARES+=("$share")
    else
        FAILED_SHARES+=("$share")
    fi
done <<< "$ENABLED_SHARES"

# Report results
log ""
log "========================================="
log "Network Share Mount Check Complete"
log "========================================="

if [[ ${#SUCCEEDED_SHARES[@]} -gt 0 ]]; then
    log "✓ Successfully mounted shares (${#SUCCEEDED_SHARES[@]}):"
    for share in "${SUCCEEDED_SHARES[@]}"; do
        log "  ✓ $share"
    done
fi

if [[ ${#FAILED_SHARES[@]} -gt 0 ]]; then
    log_error ""
    log_error "✗ Failed to mount shares (${#FAILED_SHARES[@]}):"
    for share in "${FAILED_SHARES[@]}"; do
        log_error "  ✗ $share"
    done
    log_error ""
    log_error "APP START BLOCKED: Some network shares are not available."
    log_error "Audiobookshelf will NOT start until all enabled shares are mounted."
    log_error ""
    log_error "To proceed, you can either:"
    log_error "  1. Fix the NAS connection and restart this app"
    log_error "  2. Disable unavailable shares in Network Shares settings"
    log_error "  3. Remove the shares from Umbrel's Files app"
    exit 1
fi

log "✓ All enabled network shares are mounted and accessible"
log "Audiobookshelf will now start."
exit 0
