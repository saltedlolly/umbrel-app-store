#!/usr/bin/env bash
#
# Pre-start hook for Audiobookshelf
# Waits for selected network shares to be mounted before allowing the app to start
# This prevents the "share isn't mounted yet" problem after reboots
#
# Configuration is read from ${APP_DATA_DIR}/network-shares.json
# This file is managed by the network-shares-ui sidecar service
#
set -euo pipefail

# Configuration
readonly CONFIG_FILE="${APP_DATA_DIR}/network-shares.json"
readonly MAX_WAIT_SECONDS=300  # 5 minutes total timeout
readonly CHECK_INTERVAL=2      # Check every 2 seconds
readonly NETWORK_MOUNT_ROOT="${UMBREL_ROOT}/network"
readonly AUDIOBOOKSHELF_HOME="${UMBREL_ROOT}/home/Audiobookshelf"
readonly AUDIOBOOKS_DIR="${AUDIOBOOKSHELF_HOME}/Audiobooks"
readonly PODCASTS_DIR="${AUDIOBOOKSHELF_HOME}/Podcasts"

# Logging helpers
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] $*"
}

log_error() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] ERROR: $*" >&2
}

log_warn() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [PRE-START] WARN: $*" >&2
}

# Check if jq is available for JSON parsing
if ! command -v jq &> /dev/null; then
    log_error "jq is not installed. Cannot parse network shares configuration."
    log_error "Continuing anyway, but network share wait functionality is disabled."
    exit 0
fi

# Fix permissions on APP_DATA_DIR (Umbrel creates these but not with correct ownership)
log "Checking permissions on app data directories..."

if [[ -d "${APP_DATA_DIR}" ]]; then
    # Check current ownership
    CURRENT_OWNER=$(stat -c '%u:%g' "${APP_DATA_DIR}" 2>/dev/null || stat -f '%u:%g' "${APP_DATA_DIR}" 2>/dev/null)
    
    if [[ "${CURRENT_OWNER}" != "1000:1000" ]]; then
        log_warn "App data directory has wrong ownership: ${CURRENT_OWNER}"
        log_info "Fixing ownership to 1000:1000..."
        
        if ! chown -R 1000:1000 "${APP_DATA_DIR}"; then
            log_error "Failed to fix ownership on ${APP_DATA_DIR}"
            log_error "Please run manually: sudo chown -R 1000:1000 ${APP_DATA_DIR}"
            exit 1
        fi
        
        log "âœ“ App data directory ownership fixed"
    else
        log "âœ“ App data directory ownership is correct"
    fi
fi

# Ensure media directories exist in /home (config/metadata in APP_DATA_DIR is auto-created by Umbrel)
log "Ensuring media directories exist in /home/Audiobookshelf..."

# Create Audiobooks directory
if [[ ! -d "${AUDIOBOOKS_DIR}" ]]; then
    log "Creating Audiobooks directory: ${AUDIOBOOKS_DIR}"
    if mkdir -p "${AUDIOBOOKS_DIR}"; then
        log "âœ“ Audiobooks directory created successfully"
    else
        log_error "Failed to create Audiobooks directory"
        exit 1
    fi
else
    log "âœ“ Audiobooks directory already exists"
fi

# Create README in Audiobooks directory
cat > "${AUDIOBOOKS_DIR}/README.txt" << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        AUDIOBOOKS FOLDER - ORGANIZATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This folder is for storing your audiobook files. Audiobookshelf will scan this
directory to build your audiobook library.

ðŸ“ RECOMMENDED FOLDER STRUCTURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Audiobooks/
â”œâ”€â”€ Author Name/
â”‚   â”œâ”€â”€ Series Name/
â”‚   â”‚   â”œâ”€â”€ Book 1 - Title/
â”‚   â”‚   â”‚   â”œâ”€â”€ Audio Track 1.mp3
â”‚   â”‚   â”‚   â”œâ”€â”€ Audio Track 2.mp3
â”‚   â”‚   â”‚   â””â”€â”€ cover.jpg
â”‚   â”‚   â””â”€â”€ Book 2 - Title/
â”‚   â”‚       â””â”€â”€ Audiobook.m4b
â”‚   â””â”€â”€ Standalone Book/
â”‚       â””â”€â”€ Audio File.m4a
â””â”€â”€ Another Author/
    â””â”€â”€ Book Title/
        â”œâ”€â”€ Disc 1/
        â”‚   â”œâ”€â”€ Track 1.mp3
        â”‚   â””â”€â”€ Track 2.mp3
        â””â”€â”€ Disc 2/
            â”œâ”€â”€ Track 1.mp3
            â””â”€â”€ Track 2.mp3

ðŸ“ FOLDER NAMING CONVENTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

You can include additional metadata in folder names:

â€¢ Title only:              "Wizards First Rule"
â€¢ With narrator:           "Wizards First Rule {Sam Tsoutsouvas}"
â€¢ With publish year:       "1994 - Wizards First Rule"
â€¢ With series sequence:    "Book 1 - Wizards First Rule"
â€¢ With subtitle:           "Wizards First Rule - A Really Good Subtitle"
â€¢ Full format:             "Vol 1 - 1994 - Wizards First Rule {Narrator}"

Author names support:
â€¢ First Last:              "Terry Goodkind"
â€¢ Last, First:             "Goodkind, Terry"
â€¢ Multiple authors:        "Author One & Author Two"
                          "Last1, First1, Last2, First2"

ðŸŽµ SUPPORTED AUDIO FORMATS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.mp3, .m4b, .m4a, .flac, .opus, .ogg, .oga, .mp4, .aac, .wma, .aiff, .wav, .webm

ðŸ’¡ TIPS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ All audio files in a folder will be grouped into one audiobook
â€¢ Subfolders for the audiobook are supported but the folders must be named 
  "Disc 1", "CD 2", "Disk 3", "Disc004", or "Disc1" (case insensitive)
â€¢ Place a cover.jpg/png in the folder for custom cover art
â€¢ Audiobookshelf can read metadata from audio file ID3 tags
â€¢ To add the same audiobook to multiple book series, use mp3tag to edit the CONTENTGROUP tag. 
  (e.g. For the book "The Alloy of Law" by Brandon Sanderson, you could enter:
  "Mistborn Saga #5; Mistborn: Wax & Wayne #1; The Cosmere" to add it to these three series)
â€¢ Create a desc.txt file for custom descriptions
â€¢ Create a reader.txt file to specify narrator

ðŸ“š LEARN MORE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For complete documentation on organizing audiobooks:
https://www.audiobookshelf.org/docs/#book-directory-structure

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# Create Podcasts directory
if [[ ! -d "${PODCASTS_DIR}" ]]; then
    log "Creating Podcasts directory: ${PODCASTS_DIR}"
    if mkdir -p "${PODCASTS_DIR}"; then
        log "âœ“ Podcasts directory created successfully"
    else
        log_error "Failed to create Podcasts directory"
        exit 1
    fi
else
    log "âœ“ Podcasts directory already exists"
fi

# Create README in Podcasts directory
cat > "${PODCASTS_DIR}/README.txt" << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         PODCASTS FOLDER - ORGANIZATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This folder is for storing podcast episodes you've downloaded manually.
Audiobookshelf can also subscribe to and auto-download podcasts directly.

ðŸ“ RECOMMENDED FOLDER STRUCTURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Podcasts/
â”œâ”€â”€ Podcast Name 1/
â”‚   â”œâ”€â”€ Episode 1.mp3
â”‚   â”œâ”€â”€ Episode 2.mp3
â”‚   â”œâ”€â”€ Episode 3.mp3
â”‚   â””â”€â”€ cover.jpg
â””â”€â”€ Podcast Name 2/
    â”œâ”€â”€ #01 - Episode Title.mp3
    â”œâ”€â”€ #02 - Another Episode.mp3
    â””â”€â”€ cover.png

âš ï¸  IMPORTANT: FLAT STRUCTURE ONLY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Podcasts do NOT support nested folders (no season folders).
All episodes for a podcast must be in the same folder with the podcast name.

âœ… Correct:   Podcasts/My Podcast/episode1.mp3
âŒ Incorrect: Podcasts/My Podcast/Season 1/episode1.mp3

ðŸŽµ SUPPORTED AUDIO FORMATS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

.mp3, .m4a, .flac, .opus, .ogg, .oga, .mp4, .aac, .wma, .aiff, .wav, .webm

ðŸ’¡ BETTER OPTION: SUBSCRIBE IN AUDIOBOOKSHELF
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Instead of manually downloading and organizing podcast files, you can:

1. Search for podcasts directly in Audiobookshelf
2. Subscribe to podcasts
3. Auto-download new episodes
4. Manage episodes from within the app

Manual file organization is only needed if you have existing podcast files
or want to archive episodes.

ðŸ“š LEARN MORE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For complete documentation on podcasts:
https://www.audiobookshelf.org/docs/#podcast-directory-structure

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# Set ownership to 1000:1000 so Audiobookshelf container can write to media directories
log "Setting ownership to 1000:1000 on media directories..."
if ! chown -R 1000:1000 "${AUDIOBOOKSHELF_HOME}"; then
    log_error "Failed to set ownership on ${AUDIOBOOKSHELF_HOME}"
    log_error "Please run manually: sudo chown -R 1000:1000 ~/umbrel/home/Audiobookshelf/"
    exit 1
fi

log "âœ“ Media directories ready at ${AUDIOBOOKSHELF_HOME}"
log "These directories are visible in Files app at /Home/Audiobookshelf and survive app uninstalls"

# Check if config file exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    log "No network shares configuration found at $CONFIG_FILE"
    log "No network shares configured - starting app immediately."
    log "You can configure network shares at: http://umbrel.local:23378"
    exit 0
fi

# Parse enabled shares from config
log "Reading network shares configuration from $CONFIG_FILE"
ENABLED_SHARES=$(jq -r '.enabledShares[]?' "$CONFIG_FILE" 2>/dev/null || echo "")

if [[ -z "$ENABLED_SHARES" ]]; then
    log "No network shares are enabled in configuration"
    log "Starting app immediately (no shares to wait for)."
    log "Configure network shares at: http://umbrel.local:23378"
    exit 0
fi

log "Found enabled network shares in configuration:"
while IFS= read -r share; do
    log "  - $share"
done <<< "$ENABLED_SHARES"

# Function to check if a mount point is actually mounted and accessible
is_mount_accessible() {
    local mount_path="$1"
    
    # Check 1: Does the path exist?
    if [[ ! -d "$mount_path" ]]; then
        return 1
    fi
    
    # Check 2: Is it actually mounted? (using mountpoint command if available)
    if command -v mountpoint &> /dev/null; then
        if ! mountpoint -q "$mount_path" 2>/dev/null; then
            return 1
        fi
    fi
    
    # Check 3: Can we actually read from it?
    if ! ls "$mount_path" &> /dev/null; then
        return 1
    fi
    
    # Check 4: Is it not empty (genuine NAS mount issue detection)
    # Note: An empty directory might indicate the mount failed silently
    local file_count
    file_count=$(find "$mount_path" -maxdepth 1 -type f -o -type d | wc -l)
    if [[ $file_count -le 1 ]]; then
        log_warn "Mount path $mount_path exists but appears empty (might not be mounted)"
        # Don't fail on this - empty NAS folders are valid
    fi
    
    return 0
}

# Function to wait for a single share to be mounted
wait_for_share() {
    local share_name="$1"
    local start_time
    start_time=$(date +%s)
    
    # Construct the full mount path
    # Network shares are typically mounted at /Network/<host>/<share> in Umbrel's virtual filesystem
    # But the actual system path is ${UMBREL_ROOT}/data/storage/network/<host>/<share>
    local mount_path="${NETWORK_MOUNT_ROOT}/${share_name}"
    
    log "Waiting for network share to be mounted: $share_name"
    log "Expected mount path: $mount_path"
    
    while true; do
        local current_time
        current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        
        if [[ $elapsed -ge $MAX_WAIT_SECONDS ]]; then
            log_error "Timeout waiting for network share: $share_name"
            log_error "Mount path: $mount_path"
            log_error "The share did not become available within $MAX_WAIT_SECONDS seconds."
            log_error ""
            log_error "Possible reasons:"
            log_error "  1. The NAS/network storage is offline or unreachable"
            log_error "  2. Network connectivity issues"
            log_error "  3. Incorrect credentials (check Umbrel Files app)"
            log_error "  4. The share was removed from Umbrel's Files app"
            log_error ""
            log_error "Please check:"
            log_error "  - Is the NAS powered on and connected to the network?"
            log_error "  - Can you access the share in Umbrel's Files app?"
            log_error "  - Are the credentials still valid?"
            log_error ""
            log_error "You can:"
            log_error "  - Fix the NAS connection and restart this app"
            log_error "  - Disable this share in the Network Shares settings"
            return 1
        fi
        
        if is_mount_accessible "$mount_path"; then
            log "âœ“ Network share is mounted and accessible: $share_name"
            return 0
        fi
        
        # Show progress every 10 seconds
        if [[ $((elapsed % 10)) -eq 0 ]] && [[ $elapsed -gt 0 ]]; then
            log "Still waiting for $share_name... (${elapsed}s elapsed)"
        fi
        
        sleep "$CHECK_INTERVAL"
    done
}

# Main logic: Wait for all enabled shares
log "Starting network share availability check..."
log "Maximum wait time: ${MAX_WAIT_SECONDS}s per share"

FAILED_SHARES=()
SUCCEEDED_SHARES=()

while IFS= read -r share; do
    if [[ -z "$share" ]]; then
        continue
    fi
    
    if wait_for_share "$share"; then
        SUCCEEDED_SHARES+=("$share")
    else
        FAILED_SHARES+=("$share")
    fi
done <<< "$ENABLED_SHARES"

# Report results
log ""
log "========================================="
log "Network Share Mount Check Complete"
log "========================================="

if [[ ${#SUCCEEDED_SHARES[@]} -gt 0 ]]; then
    log "âœ“ Successfully mounted shares (${#SUCCEEDED_SHARES[@]}):"
    for share in "${SUCCEEDED_SHARES[@]}"; do
        log "  âœ“ $share"
    done
fi

if [[ ${#FAILED_SHARES[@]} -gt 0 ]]; then
    log_error ""
    log_error "âœ— Failed to mount shares (${#FAILED_SHARES[@]}):"
    for share in "${FAILED_SHARES[@]}"; do
        log_error "  âœ— $share"
    done
    log_error ""
    log_error "APP START BLOCKED: Some network shares are not available."
    log_error "Audiobookshelf will NOT start until all enabled shares are mounted."
    log_error ""
    log_error "To proceed, you can either:"
    log_error "  1. Fix the NAS connection and restart this app"
    log_error "  2. Disable unavailable shares in Network Shares settings"
    log_error "  3. Remove the shares from Umbrel's Files app"
    exit 1
fi

log "âœ“ All enabled network shares are mounted and accessible"
log "Audiobookshelf will now start."
exit 0
