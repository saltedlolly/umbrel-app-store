version: "3.7"

services:
  app_proxy:
    environment:
      # ABS Network Shares Config Tool is primary (accessible via dashboard icon on port 23378)
      APP_HOST: saltedlolly-audiobookshelf_abs-network-shares-config-tool_1
      APP_PORT: 3001
      PROXY_AUTH_ADD: "true"

  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1      # Allow container read operations
      - POST=1            # Allow POST requests (container create/start)
      - DELETE=1          # Allow DELETE requests (container remove)
      - IMAGES=1          # Allow image inspect required by container create
      - NETWORKS=0
      - VOLUMES=0
      - INFO=1            # Allow /info for health/status
      - EVENTS=1          # Allow /events for monitoring
      - AUTH=0
      - SYSTEM=0
      - SERVICES=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "2375:2375"       # Expose proxy on port 2375 (internal only)

  # Lightweight UI service for managing and monitoring required network shares selection
  # Accessible via app_proxy on port 23378 (or via Umbreldashboard icon)
  abs-network-shares-config-tool:
    image: saltedlolly/abs-network-shares-config-tool@sha256:70f84fcaa9c89c3a9a01efbfb1df18a65472a116d16c3b431b19ff42c8b01cfc
    container_name: saltedlolly-audiobookshelf_abs-network-shares-config-tool_1
    hostname: saltedlolly-audiobookshelf_abs-network-shares-config-tool_1
    init: true
    restart: unless-stopped
    user: "1000:999"  # node user with docker group for socket access
    environment:
      - APP_DATA_DIR=${APP_DATA_DIR}
      - NODE_ENV=production
    volumes:
      - ${APP_DATA_DIR}/data:/data
      # Mount the Umbrel network storage root (read-only) so we can discover shares
      - ${UMBREL_ROOT}/network:/umbrel-network:ro
      # Mount docker socket to check Audiobookshelf container status
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3001/health"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 2s

  # Background service that manages starting Audiobookshelf. At launch, it runs abs-network-share-waiter-checker  
  # repeatedly which checks all required networkshares are accessible and starts abs-server only once they are.
  abs-manager:
    image: saltedlolly/abs-manager@sha256:8e44acd5a5c8258bbccae19913df17c898a9adc0b4e952bbf47114d19a038826
    container_name: saltedlolly-audiobookshelf_abs-manager_1
    restart: unless-stopped
    environment:
      - APP_DATA_DIR=${APP_DATA_DIR}
      - UMBREL_ROOT=${UMBREL_ROOT}
    volumes:
      - ${APP_DATA_DIR}/data:/data
    depends_on:
      - docker-socket-proxy
    networks:
      - default
